-- QUAN LY GIAO VU
CREATE DATABASE QLDV

-- BUOI 1
CREATE TABLE HOCVIEN (
	MAHV		char(5)	NOT NULL		PRIMARY KEY,
	HO			varchar(40),
	TEN			varchar(10),
	NGSINH		smalldatetime,
	GIOITINH	varchar(3),
	NOISINH		varchar(40),
	MALOP		char(3)
)

CREATE TABLE LOP (
	MALOP		char(3)	NOT NULL		PRIMARY KEY,
	TENLOP		varchar(40),
	TRGLOP		char(5),
	SISO		tinyint,
	MAGVCN		char(4)
)

CREATE TABLE KHOA(
	MAKHOA		varchar(4) NOT NULL		PRIMARY KEY,
	TENKHOA		varchar(40),
	NGTLAP		smalldatetime,
	TRGKHOA		char(4)
)

CREATE TABLE MONHOC(
	MAMH		char(4) NOT NULL		PRIMARY KEY,
	TENMH		varchar(40),
	TCLT		tinyint,
	TCTH		tinyint,
	MAKHOA		varchar(4)
)

CREATE TABLE DIEUKIEN (
	MANH			varchar(10),
	MAMH_TRUOC		varchar(10)
)

CREATE TABLE GIAOVIEN (
	MAGV		char(4) NOT NULL		PRIMARY KEY,
	HOTEN		varchar(40),
	HOCVI		varchar(10),
	HOCHAM		varchar(10),
	GIOITINH	varchar(3),
	NGSINH		smalldatetime,
	NGVL		smalldatetime,
	HESO		numeric(4,2),
	MUCLUONG	money,
	MAKHOA		varchar(4)
)

CREATE TABLE GIANGDAY (
	MALOP		char(3),
	MAMH		varchar(10),
	MAGV		char(4),
	HOCKY		tinyint,
	NAM			smallint,
	TUNGAY		smalldatetime,
	DENNGAY		smalldatetime
)

CREATE TABLE KETQUATHI (
	MAHV		char(5),
	MAMH		varchar(10),
	LANTHI		tinyint,
	NGTHI		smalldatetime,
	DIEM		numeric(4,2),
	KQUA		varchar(10)
)

ALTER TABLE KHOA		ADD
CONSTRAINT FK_TRGKHOA_KHOA		FOREIGN KEY (TRGKHOA)			REFERENCES GIAOVIEN(MAGV)

ALTER TABLE DIEUKIEN	ADD
CONSTRAINT FK_DIEUKIEN			FOREIGN KEY (MAMH)	REFERENCES MONHOC(MAMH)

ALTER TABLE LOP			ADD
CONSTRAINT FK_LPTRG_LOP			FOREIGN KEY (TRGLOP)			REFERENCES HOCVIEN(MAHV),
CONSTRAINT FK_GVCN_LOP			FOREIGN KEY (MAGVCN)			REFERENCES GIAOVIEN(MAGV)

ALTER TABLE GIANGDAY	ADD
CONSTRAINT FK_MALOP_GD			FOREIGN KEY (MALOP)				REFERENCES LOP(MALOP),
CONSTRAINT FK_MAMH_GD			FOREIGN KEY (MAMH)				REFERENCES MONHOC(MAMH)

ALTER TABLE KETQUATHI	ADD
CONSTRAINT FK_MAMH_KQT			FOREIGN KEY (MAMH)				REFERENCES MONHOC(MAMH),
CONSTRAINT FK_MAHV_KQT			FOREIGN KEY (MAHV)				REFERENCES HOCVIEN(MAHV)

ALTER TABLE HOCVIEN		ADD		GHICHU		varchar(100)
ALTER TABLE HOCVIEN		ADD		DIEMTB		numeric(4,2)

-- 3. THUOC TINH GIOI TINH CUA HOCVIEN NHAN "NAM" VA "NU"
ALTER TABLE HOCVIEN		ADD
CONSTRAINT chk_gioitinh CHECK (GIOITINH IN ("NAM", "NU"))

-- 4. DIEM SO CUA MOT LAN THI NHAN GIA TRI TU 1 DEN 10 VA LUU 2 SO SAU DAU PHAY
ALTER TABLE KETQUATHI	ADD
CONSTRAINT chk_diem		CHECK (DIEM >= 0 AND DIEM <= 10)

-- 5. KET QUA THI LA DAT NEU DIEM TU 5 DEN 10 VA KHONG DAT NEU DUOI 5
SELECT 
	MAHV,
	DIEM,
	CASE 
		WHEN DIEM >= 5 AND DIEM <= 10 THEN 'DAT'
		ELSE 'KHONG DAT'
	END AS KQUA
FROM KETQUATHI

-- 6. HOC VIEN THI TOI DA 3 LAN 1 MON
ALTER TABLE KETQUATHI ADD 
CONSTRAINT chk_lanthi CHECK (LANTHI BETWEEN 0 AND 3)

-- 7. HOC KY CHI CO THE TU 1 DEN 3
ALTER TABLE GIANGDAY ADD 
CONSTRAINT chk_hocky CHECK (HOCKY BETWEEN 1 AND 3)


-- 8. HOC VI CUA GIAO VIEN CHI CO THE LA “CN”, “KS”, “Ths”, ”TS”, ”PTS”.
ALTER TABLE GIAOVIEN ADD
CONSTRAINT chk_hocvi CHECK (HOCVI IN ("CN", "KS", "ThS", "TS", "PTS"))

SET DATEFORMAT DMY
--KHOA

INSERT INTO KHOA VALUES('KHMT','Khoa hoc may tinh','06/07/2005','GV01')
INSERT INTO KHOA VALUES('HTTT','He thong thong tin','06/07/2005','GV02')
INSERT INTO KHOA VALUES('CNPM','Cong nghe phan mem','06/07/2005','GV04')
INSERT INTO KHOA VALUES('MTT','Mang va truyen thong','20/10/2005','GV03')
INSERT INTO KHOA VALUES('KTMT','Ky thuat may tinh','20/12/2005','Null')

SELECT * FROM KHOA


--GIAO VIEN
INSERT INTO GIAOVIEN VALUES('GV01','Ho Thanh Son','PTS','GS','Nam','05/02/1950','01/11/2004',5,2250000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV02','Tran Tam Thanh','TS','PGS','Nam','17/12/1965','20/4/2004',4.5,2025000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV03','Do Nghiem Phung','TS','GS','Nu','08/01/1950','23/9/2004',4,1800000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV04','Tran Nam Son','TS','PGS','Nam','22/2/1961','01/12/2005',4.5,2025000,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV05','Mai Thanh Danh','ThS','GV','Nam','03/12/1958','01/12/2005',3,1350000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV06','Tran Doan Hung','TS','GV','Nam','03/11/1953','01/12/2005',4.5,2025000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV07','Nguyen Minh Tien','ThS','GV','Nam','23/11/1971','03/01/2005',4,1800000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV08','Le Thi Tran','KS',null,'Nu','26/3/1974','03/01/2005',1.69,760500,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV09','Nguyen To Lan','ThS','GV','Nu','31/12/1966','03/01/2005',4,1800000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV10','Le Tran Anh Loan','KS',null,'Nu','17/7/1972','03/01/2005',1.86,837000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV11','Ho Thanh Tung','CN','GV','Nam','01/12/1980','15/5/2005',2.67,1201500,'MTT')
INSERT INTO GIAOVIEN VALUES('GV12','Tran Van Anh','CN',null,'Nu','29/3/1981','15/5/2005',1.69,760500,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV13','Nguyen Linh Dan','CN',null,'Nu','23/5/1980','15/5/2005',1.69,760500,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV14','Truong Minh Chau','ThS','GV','Nu','30/11/1976','15/5/2005',3,1350000,'MTT')
INSERT INTO GIAOVIEN VALUES('GV15','Le Ha Thanh','ThS','GV','Nam','05/04/1978','15/5/2005',3,1350000,'KHMT')

SELECT * FROM GIAOVIEN

--LOP
INSERT INTO LOP VALUES('K11','Lop 1 khoa 1','K1108',11,'GV07')
INSERT INTO LOP VALUES('K12','Lop 2 khoa 1','K1205',12,'GV09')
INSERT INTO LOP VALUES('K13','Lop 3 khoa 1','K1305',12,'GV14')

SELECT * FROM LOP

--MON HOC
INSERT INTO MONHOC VALUES('THDC','Tin hoc dai cuong',4,1,'KHMT')
INSERT INTO MONHOC VALUES('CTRR','Cau truc roi rac',5,0,'KHMT')
INSERT INTO MONHOC VALUES('CSDL','Co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('CTDLGT','Cau truc du lieu va giai thuat',3,1,'KHMT')
INSERT INTO MONHOC VALUES('PTTKTT','Phan tich thiet ke thuat toan',3,0,'KHMT')
INSERT INTO MONHOC VALUES('DHMT','Do hoa may tinh',3,1,'KHMT')
INSERT INTO MONHOC VALUES('KTMT','Kien truc may tinh',3,0,'KTMT')
INSERT INTO MONHOC VALUES('TKCSDL','Thiet ke co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('PTTKHTTT','Phan tich thiet ke he thong thong tin',4,1,'HTTT')
INSERT INTO MONHOC VALUES('HDH','He dieu hanh',4,0,'KTMT')
INSERT INTO MONHOC VALUES('NMCNPM','Nhap mon cong nghe phan mem',3,0,'CNPM')
INSERT INTO MONHOC VALUES('LTCFW','Lap trinh C for win',3,1,'CNPM')
INSERT INTO MONHOC VALUES('LTHDT','Lap trinh huong doi tuong',3,1,'CNPM')

SELECT * FROM MONHOC

--GIANG DAY
INSERT INTO GIANGDAY VALUES('K11','THDC','GV07',1,2006,'01/02/2006','05/12/2006')
INSERT INTO GIANGDAY VALUES('K12','THDC','GV06',1,2006,'01/02/2006','05/12/2006')
INSERT INTO GIANGDAY VALUES('K13','THDC','GV15',1,2006,'01/02/2006','05/12/2006')
INSERT INTO GIANGDAY VALUES('K11','CTRR','GV02',1,2006,'09/01/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K12','CTRR','GV02',1,2006,'09/01/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K13','CTRR','GV08',1,2006,'09/01/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K11','CSDL','GV05',2,2006,'06/01/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K12','CSDL','GV09',2,2006,'06/01/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K13','CTDLGT','GV15',2,2006,'06/01/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K13','CSDL','GV05',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K13','DHMT','GV07',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K11','CTDLGT','GV15',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K12','CTDLGT','GV15',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K11','HDH','GV04',1,2007,'01/02/2007','18/2/2007')
INSERT INTO GIANGDAY VALUES('K12','HDH','GV04',1,2007,'01/02/2007','20/3/2007')
INSERT INTO GIANGDAY VALUES('K11','DHMT','GV07',1,2007,'18/2/2007','20/3/2007')

SELECT * FROM GIANGDAY

--HOC VIEN
INSERT INTO HOCVIEN VALUES('K1101','Nguyen Van','A','27/1/1986','Nam','TpHCM','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1102','Tran Ngoc','Han','14/3/1986','Nu','Kien Giang','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1103','Ha Duy','Lap','18/4/1986','Nam','Nghe An','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1104','Tran Ngoc','Linh','30/3/1986','Nu','Tay Ninh','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1105','Tran Minh','Long','27/2/1986','Nam','TpHCM','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1106','Le Nhat','Minh','24/1/1986','Nam','TpHCM','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1107','Nguyen Nhu','Nhut','27/1/1986','Nam','Ha Noi','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1108','Nguyen Manh','Tam','27/2/1986','Nam','Kien Giang','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1109','Phan Thi Thanh','Tam','27/1/1986','Nu','Vinh Long','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1110','Le Hoai','Thuong','02/05/1986','Nu','Can Tho','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1111','Le Ha','Vinh','25/12/1986','Nam','Vinh Long','K11', null, null, null)
INSERT INTO HOCVIEN VALUES('K1201','Nguyen Van','B','02/11/1986','Nam','TpHCM','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1202','Nguyen Thi Kim','Duyen','18/1/1986','Nu','TpHCM','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1203','Tran Thi Kim','Duyen','17/9/1986','Nu','TpHCM','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1204','Truong My','Hanh','19/5/1986','Nu','Dong Nai','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1205','Nguyen Thanh','Nam','17/4/1986','Nam','TpHCM','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1206','Nguyen Thi Truc','Thanh','03/04/1986','Nu','Kien Giang','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1207','Tran Thi Bich','Thuy','02/08/1986','Nu','Nghe An','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1208','Huynh Thi Kim','Trieu','04/08/1986','Nu','Tay Ninh','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1209','Pham Thanh','Trieu','23/2/1986','Nam','TpHCM','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1210','Ngo Thanh','Tuan','14/2/1986','Nam','TpHCM','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1211','Do Thi','Xuan','03/09/1986','Nu','Ha Noi','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1212','Le Thi Phi','Yen','03/12/1986','Nu','TpHCM','K12', null, null, null)
INSERT INTO HOCVIEN VALUES('K1301','Nguyen Thi Kim','Cuc','06/09/1986','Nu','Kien Giang','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1302','Truong Thi My','Hien','18/3/1986','Nu','Nghe An','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1303','Le Duc','Hien','21/3/1986','Nam','Tay Ninh','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1304','Le Quang','Hien','18/4/1986','Nam','TpHCM','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1305','Le Thi','Huong','27/3/1986','Nu','TpHCM','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1306','Nguyen Thai','Huu','30/3/1986','Nam','Ha Noi','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1307','Tran Minh','Man','28/5/1986','Nam','TpHCM','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1308','Nguyen Hieu','Nghia','04/08/1986','Nam','Kien Giang','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1309','Nguyen Trung','Nghia','18/1/1987','Nam','Nghe An','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1310','Tran Thi Hong','Tham','22/4/1986','Nu','Tay Ninh','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1311','Tran Minh','Thuc','04/04/1986','Nam','TpHCM','K13', null, null, null)
INSERT INTO HOCVIEN VALUES('K1312','Nguyen Thi Kim','Yen','09/07/1986','Nu','TpHCM','K13', null, null, null)

SELECT * FROM HOCVIEN

--KET QUA THI
INSERT INTO KETQUATHI VALUES('K1101','CSDL',1,'20/7/2006',10,'DAT')
INSERT INTO KETQUATHI VALUES('K1101','CTDLGT',1,'28/12/2006',9,'DAT')
INSERT INTO KETQUATHI VALUES('K1101','THDC',1,'20/5/2006',9,'DAT')
INSERT INTO KETQUATHI VALUES('K1101','CTRR',1,'13/5/2006',9.5,'DAT')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',1,'20/7/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',2,'27/7/2006',4.25,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',3,'08/10/2006',4.5,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',1,'28/12/2006',4.5,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',2,'01/05/2007',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',3,'15/1/2007',6,'DAT')
INSERT INTO KETQUATHI VALUES('K1102','THDC',1,'20/5/2006',5,'DAT')
INSERT INTO KETQUATHI VALUES('K1102','CTRR',1,'13/5/2006',7,'DAT')
INSERT INTO KETQUATHI VALUES('K1103','CSDL',1,'20/7/2006',3.5,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1103','CSDL',2,'27/7/2006',8.25,'DAT')
INSERT INTO KETQUATHI VALUES('K1103','CTDLGT',1,'28/12/2006',7,'DAT')
INSERT INTO KETQUATHI VALUES('K1103','THDC',1,'20/5/2006',8,'DAT')
INSERT INTO KETQUATHI VALUES('K1103','CTRR',1,'13/5/2006',6.5,'DAT')
INSERT INTO KETQUATHI VALUES('K1104','CSDL',1,'20/7/2006',3.75,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1104','CTDLGT',1,'28/12/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1104','THDC',1,'20/5/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',1,'13/5/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',2,'20/5/2006',3.5,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',3,'30/6/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1201','CSDL',1,'20/7/2006',6,'DAT')
INSERT INTO KETQUATHI VALUES('K1201','CTDLGT',1,'28/12/2006',5,'DAT')
INSERT INTO KETQUATHI VALUES('K1201','THDC',1,'20/5/2006',8.5,'DAT')
INSERT INTO KETQUATHI VALUES('K1201','CTRR',1,'13/5/2006',9,'DAT')
INSERT INTO KETQUATHI VALUES('K1202','CSDL',1,'20/7/2006',8,'DAT')
INSERT INTO KETQUATHI VALUES('K1202','CTDLGT',1,'28/12/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1202','CTDLGT',2,'01/05/2007',5,'DAT')
INSERT INTO KETQUATHI VALUES('K1202','THDC',1,'20/5/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1202','THDC',2,'27/5/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',1,'13/5/2006',3,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',2,'20/5/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',3,'30/6/2006',6.25,'DAT')
INSERT INTO KETQUATHI VALUES('K1203','CSDL',1,'20/7/2006',9.25,'DAT')
INSERT INTO KETQUATHI VALUES('K1203','CTDLGT',1,'28/12/2006',9.5,'DAT')
INSERT INTO KETQUATHI VALUES('K1203','THDC',1,'20/5/2006',10,'DAT')
INSERT INTO KETQUATHI VALUES('K1203','CTRR',1,'13/5/2006',10,'DAT')
INSERT INTO KETQUATHI VALUES('K1204','CSDL',1,'20/7/2006',8.5,'DAT')
INSERT INTO KETQUATHI VALUES('K1204','CTDLGT',1,'28/12/2006',6.75,'DAT')
INSERT INTO KETQUATHI VALUES('K1204','THDC',1,'20/5/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1204','CTRR',1,'13/5/2006',6,'DAT')
INSERT INTO KETQUATHI VALUES('K1301','CSDL',1,'20/12/2006',4.25,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1301','CTDLGT',1,'25/7/2006',8,'DAT')
INSERT INTO KETQUATHI VALUES('K1301','THDC',1,'20/5/2006',7.75,'DAT')
INSERT INTO KETQUATHI VALUES('K1301','CTRR',1,'13/5/2006',8,'DAT')
INSERT INTO KETQUATHI VALUES('K1302','CSDL',1,'20/12/2006',6.75,'DAT')
INSERT INTO KETQUATHI VALUES('K1302','CTDLGT',1,'25/7/2006',5,'DAT')
INSERT INTO KETQUATHI VALUES('K1302','THDC',1,'20/5/2006',8,'DAT')
INSERT INTO KETQUATHI VALUES('K1302','CTRR',1,'13/5/2006',8.5,'DAT')
INSERT INTO KETQUATHI VALUES('K1303','CSDL',1,'20/12/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',1,'25/7/2006',4.5,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',2,'08/07/2006',4,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',3,'15/8/2006',4.25,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1303','THDC',1,'20/5/2006',4.5,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1303','CTRR',1,'13/5/2006',3.25,'KHONG_DAT')
INSERT INTO KETQUATHI VALUES('K1303','CTRR',2,'20/5/2006',5,'DAT')
INSERT INTO KETQUATHI VALUES('K1304','CSDL',1,'20/12/2006',7.75,'DAT')
INSERT INTO KETQUATHI VALUES('K1304','CTDLGT',1,'25/7/2006',9.75,'DAT')
INSERT INTO KETQUATHI VALUES('K1304','THDC',1,'20/5/2006',5.5,'DAT')
INSERT INTO KETQUATHI VALUES('K1304','CTRR',1,'13/5/2006',5,'DAT')
INSERT INTO KETQUATHI VALUES('K1305','CSDL',1,'20/12/2006',9.25,'DAT')
INSERT INTO KETQUATHI VALUES('K1305','CTDLGT',1,'25/7/2006',10,'DAT')
INSERT INTO KETQUATHI VALUES('K1305','THDC',1,'20/5/2006',8,'DAT')
INSERT INTO KETQUATHI VALUES('K1305','CTRR',1,'13/5/2006',10,'DAT')

SELECT * FROM KETQUATHI

-- BUOI 2
-- Phan 1
-- 11. Hoc vien it nhat la 18 tuoi
ALTER TABLE HOCVIEN ADD
CONSTRAINT CK_TUOI_HV CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 18)

-- 12. Giang day mot mon hoc ngay bat dau phai nho hon ngay ket thuc
ALTER TABLE GIANGDAY ADD
CONSTRANT CK_TG_GD CHECK (TUNGAY < DENNGAY)

-- 13. Giao vien khi vao lam phai it nhat 22 tuoi
ALTER TABLE GIAOVIEN ADD
CONSTRAINT CK_TUOI_GV CHECK (YEAR(GETDATE()) - YEAR(NGVL) >= 22)

-- 14. Tat ca mon hoc co so tin chi ly thuyet 
-- tin chi thuc hanh khong chenh lech qua 5 tin chi
ALTER TABLE MONHOC ADD
CONSTRAINT CK_TC CHECK (ABS(TCLT - TCTH) <= 5)

-- Phan 2
-- 1. Tang he so luong them 0.2 cho nhung giao vien la truong khoa
UPDATE GIAOVIEN
SET HESO = HESO + 0.2
WHERE MAGV IN (SELECT TRGKHOA FROM KHOA)

-- 2. Cập nhật giá trị điểm trung bình tất cả các môn học (DIEMTB) của mỗi học viên (tất cả các
-- môn học đều có hệ số 1 và nếu học viên thi một môn nhiều lần, chỉ lấy điểm của lần thi sau cùng).
WITH DiemLanThiCuoi AS (
    SELECT 
        MAHV,
        MAMH,
        DIEM
    FROM KETQUATHI AS K1
    WHERE NGTHI = (
        SELECT MAX(NGTHI)
        FROM KETQUATHI AS K2
        WHERE K2.MAHV = K1.MAHV AND K2.MAMH = K1.MAMH
    )
)
UPDATE HOCVIEN
SET DIEMTB = (
    SELECT AVG(DIEM)
    FROM DiemLanThiCuoi
    WHERE DiemLanThiCuoi.MAHV = HOCVIEN.MAHV
)

-- 3. Cập nhật giá trị cho cột GHICHU là “Cam thi” đối với trường hợp: học viên có một môn bất
-- kỳ thi lần thứ 3 dưới 5 điểm.

UPDATE HOCVIEN
SET GHICHU = 'Cam thi'
WHERE MAHV IN (
    SELECT MAHV
    FROM KETQUATHI
    WHERE LANTHI = 3 AND DIEM < 5
)

-- 4. Cập nhật giá trị cho cột XEPLOAI trong quan hệ HOCVIEN như sau:

-- o Nếu DIEMTB  9 thì XEPLOAI = ”XS”
-- o Nếu 8  DIEMTB < 9 thì XEPLOAI = “G”
-- o Nếu 6.5  DIEMTB < 8 thì XEPLOAI = “K”
-- o Nếu 5  DIEMTB < 6.5 thì XEPLOAI = “TB”
-- o Nếu DIEMTB < 5 thì XEPLOAI = ”Y”

UPDATE HOCVIEN
SET XEPLOAI = 
    CASE 
        WHEN DIEMTB >= 9 THEN 'XS'
        WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN 'G'
        WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN 'K'
        WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN 'TB'
        WHEN DIEMTB < 5 THEN 'Y'
    END

-- Phan 3
-- 1. In ra danh sach lop truong cua cac lop
SELECT LOP.MALOP, HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN, HOCVIEN.NGAYSINH
FROM LOP
JOIN HOCVIEN ON LOP.TRGLOP = HOCVIEN.MAHV

-- 2. In ra bang diem khi thi (mahv, hoten, lanthi, diemso) mon 'CTRR' cua lop 'K12' 
-- sap xep theo ho, ten hoc vien
SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN, KETQUATHI.LANTHI, KETQUATHI.DIEM
FROM HOCVIEN
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE KETQUATHI.MAMH = 'CTRR' AND HOCVIEN.MALOP = 'K12'
ORDER BY HOCVIEN.HO, HOCVIEN.TEN

-- 3. In ra danh sach hoc vien (mahv, hoten) va nhung mon hoc hoc vien do thi lan thu nhat dat
SELECT HOCVIEN.MAHV, HOCVIEN.HO + ' ' + HOCVIEN.TEN AS HOTEN, KETQUATHI.MAMH
FROM HOCVIEN
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE KETQUATHI.LANTHI = 1 AND KETQUATHI.KQUA = 'DAT'

-- 4. In ra danh sach hoc vien (mahv, hoten) cua lop 'K11' thi
-- mon 'CTRR' lan thu nhat khong dat

SELECT HOCVIEN.MAHV, HOCVIEN.HO + ' ' + HOCVIEN.TEN AS HOTEN
FROM HOCVIEN
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
JOIN MONTHI ON KETQUATHI.MAMH = MONTHI.MAMH
WHERE KETQUATHI.LANTHI = 1 AND KETQUATHI.KQUA = 'KHONG DAT' 
AND HOCVIEN.MALOP = 'K11' AND MONTHI.TENMH = 'CTRR'

-- 5. In ra danh sach hoc vien (mahv, hoten) cua lop 'K' thi CTRR khong dat o tat ca lan thi
SELECT HOCVIEN.MAHV, CONCAT(HOCVIEN.HO, ' ', HOCVIEN.TEN) AS HOTEN
FROM HOCVIEN
JOIN LOP ON HOCVIEN.MALOP = LOP.MALOP
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
JOIN MONHOC ON KETQUATHI.MAMH = MONHOC.MAMH
WHERE LOP.TENLOP = 'K' 
  AND MONHOC.TENMH = 'CTRR'
GROUP BY HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN
HAVING COUNT(CASE WHEN KETQUATHI.KQUA = 'Đạt' THEN 1 END) = 0

-- 6. Tim nhung ten mon hoc ma giao vien "Tran Tam Thanh" day trong hoc ky 1 nam 2006
SELECT DISTINCT MONHOC.TENMH
FROM GIANGDAY
JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
WHERE GIAOVIEN.HOTEN = 'Tran Tam Thanh'
  AND GIANGDAY.HOCKY = 1
  AND GIANGDAY.NAM = 2006

-- 7. Tìm những môn học (mã môn học, tên môn học) mà giáo viên chủ nhiệm lớp “K11” dạy
-- trong học kỳ 1 năm 2006.
SELECT MONHOC.MAMH, MONHOC.TENMH
FROM GIANGDAY
JOIN LOP ON GIANGDAY.MALOP = LOP.MALOP
JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
WHERE LOP.TENLOP = 'K11'
  AND GIANGDAY.HOCKY = 1
  AND GIANGDAY.NAM = 2006
  AND LOP.MAGVCN = GIAOVIEN.MAGV

-- 8. Tìm họ tên lớp trưởng của các lớp mà giáo viên có tên “Nguyen To Lan” dạy môn “Co So
-- Du Lieu”.
SELECT HOCVIEN.HO, HOCVIEN.TEN
FROM LOP
JOIN GIANGDAY ON LOP.MALOP = GIANGDAY.MALOP
JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
JOIN HOCVIEN ON LOP.TRGLOP = HOCVIEN.MAHV
WHERE GIAOVIEN.HOTEN = 'Nguyen To Lan'
  AND MONHOC.TENMH = 'Co So Du Lieu'

-- 9. In ra danh sách những môn học (mã môn học, tên môn học) phải học liền trước môn “Co So
-- Du Lieu”.
SELECT MONHOC.MAMH, MONHOC.TENMH
FROM MONHOC
JOIN DIEUKIEN ON MONHOC.MAMH = DIEUKIEN.MAMH_TRUOC
JOIN MONHOC AS MONHOC2 ON DIEUKIEN.MAMH = MONHOC2.MAMH
WHERE MONHOC2.TENMH = 'Co So Du Lieu'

-- 10. Môn “Cau Truc Roi Rac” là môn bắt buộc phải học liền trước những môn học (mã môn học,
-- tên môn học) nào.
SELECT MONHOC.MAMH, MONHOC.TENMH
FROM MONHOC
JOIN DIEUKIEN ON MONHOC.MAMH = DIEUKIEN.MAMH_TRUOC
WHERE DIEUKIEN.MAMH_TRUOC = 'Cau Truc Roi Rac'

-- 11. Tìm họ tên giáo viên dạy môn CTRR cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1
-- năm 2006.
SELECT GIAOVIEN.HOTEN
FROM GIANGDAY
JOIN LOP ON GIANGDAY.MALOP = LOP.MALOP
JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
WHERE MONHOC.TENMH = 'CTRR'
  AND GIANGDAY.HOCKY = 1
  AND GIANGDAY.NAM = 2006
  AND (LOP.TENLOP = 'K11' OR LOP.TENLOP = 'K12')
GROUP BY GIAOVIEN.HOTEN
HAVING COUNT(DISTINCT LOP.TENLOP) = 2

-- 12. Tìm những học viên (mã học viên, họ tên) thi không đạt môn CSDL ở lần thi thứ 1 nhưng
-- chưa thi lại môn này.
SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
JOIN MONHOC ON KETQUATHI.MAMH = MONHOC.MAMH
WHERE MONHOC.TENMH = 'CSDL'
  AND KETQUATHI.LANTHI = 1
  AND KETQUATHI.KQUA = 'Khong dat'
  AND NOT EXISTS (
    SELECT 1
    FROM KETQUATHI K2
    WHERE K2.MAHV = HOCVIEN.MAHV
      AND K2.MAMH = MONHOC.MAMH
      AND K2.LANTHI > 1
  )

-- 13. Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào.
SELECT GIAOVIEN.MAGV, GIAOVIEN.HOTEN
FROM GIAOVIEN
LEFT JOIN GIANGDAY ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE GIANGDAY.MAGV IS NULL

-- 14. Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào
-- thuộc khoa giáo viên đó phụ trách.
SELECT GIAOVIEN.MAGV, GIAOVIEN.HOTEN
FROM GIAOVIEN
LEFT JOIN GIANGDAY ON GIAOVIEN.MAGV = GIANGDAY.MAGV
LEFT JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
WHERE GIANGDAY.MAGV IS NULL
  AND MONHOC.MAKHOA = GIAOVIEN.MAKHOA

-- 15. Tìm họ tên các học viên thuộc lớp “K11” thi một môn bất kỳ quá 3 lần vẫn “Khong dat”
-- hoặc thi lần thứ 2 môn CTRR được 5 điểm.
SELECT HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
JOIN LOP ON HOCVIEN.MALOP = LOP.MALOP
JOIN MONHOC ON KETQUATHI.MAMH = MONHOC.MAMH
WHERE LOP.TENLOP = 'K11'
  AND (
    (KETQUATHI.LANTHI > 3 AND KETQUATHI.KQUA = 'Khong dat')
    OR (KETQUATHI.LANTHI = 2 AND MONHOC.TENMH = 'CTRR' AND KETQUATHI.DIEM = 5)
  )

-- 16. Tìm họ tên giáo viên dạy môn CTRR cho ít nhất hai lớp trong cùng một học kỳ của một năm học.
SELECT GIAOVIEN.HOTEN
FROM GIAOVIEN
JOIN GIANGDAY ON GIAOVIEN.MAGV = GIANGDAY.MAGV
JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
JOIN LOP ON GIANGDAY.MALOP = LOP.MALOP
WHERE MONHOC.TENMH = 'CTRR'
GROUP BY GIAOVIEN.MAGV, GIAOVIEN.HOTEN, GIANGDAY.HOCKY, GIANGDAY.NAM
HAVING COUNT(DISTINCT LOP.MALOP) >= 2

-- 17. Danh sách học viên và điểm thi môn CSDL (chỉ lấy điểm của lần thi sau cùng).
SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN, KETQUATHI.DIEM
FROM HOCVIEN
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
JOIN MONHOC ON KETQUATHI.MAMH = MONHOC.MAMH
WHERE MONHOC.TENMH = 'CSDL'
  AND KETQUATHI.LANTHI = (
    SELECT MAX(LANTHI)
    FROM KETQUATHI K2
    WHERE K2.MAHV = HOCVIEN.MAHV
      AND K2.MAMH = MONHOC.MAMH
  )

-- 18. Danh sách học viên và điểm thi môn “Co So Du Lieu” (chỉ lấy điểm cao nhất của các lần thi).
SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN, MAX(KETQUATHI.DIEM) AS DIEMCAO
FROM HOCVIEN
JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
JOIN MONHOC ON KETQUATHI.MAMH = MONHOC.MAMH
WHERE MONHOC.TENMH = 'Co So Du Lieu'
GROUP BY HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN

-- 19. Khoa nào (mã khoa, tên khoa) được thành lập sớm nhất.
SELECT MAKHOA, TENKHOA
FROM KHOA
WHERE NGTLAP = (
    SELECT MIN(NGTLAP)
    FROM KHOA
)

-- 20. Có bao nhiêu giáo viên có học hàm là “GS” hoặc “PGS”.
SELECT COUNT(*) AS SoLuongGV
FROM GIAOVIEN
WHERE HOCHAM IN ('GS', 'PGS')

-- 21. Thống kê có bao nhiêu giáo viên có học vị là “CN”, “KS”, “Ths”, “TS”, “PTS” trong mỗi khoa.
SELECT GV.MAKHOA, K.TENKHOA, GV.HOCHAM, COUNT(*) AS SoLuongGV
FROM GIAOVIEN GV
JOIN KHOA K ON GV.MAKHOA = K.MAKHOA
WHERE GV.HOCHAM IN ('CN', 'KS', 'Ths', 'TS', 'PTS')
GROUP BY GV.MAKHOA, K.TENKHOA, GV.HOCHAM
ORDER BY GV.MAKHOA, GV.HOCHAM

-- 22. Mỗi môn học thống kê số lượng học viên theo kết quả (đạt và không đạt).
SELECT MAMH, KQUA, COUNT(*) AS SoLuongHV
FROM KETQUATHI
GROUP BY MAMH, KQUA;

-- 23. Tìm giáo viên (mã giáo viên, họ tên) là giáo viên chủ nhiệm của một lớp, đồng thời dạy cho
-- lớp đó ít nhất một môn học.
SELECT DISTINCT GV.MAGV, GV.HOTEN
FROM GIAOVIEN GV, LOP L, GIANGDAY GD
WHERE L.MAGVCN = GV.MAGV AND GV.MAGV = GD.MAGV AND L.MALOP = GD.MALOP

-- 24. Tìm họ tên lớp trưởng của lớp có sỉ số cao nhất.
SELECT HV.HO, HV.TEN
FROM HOCVIEN HV, LOP L
WHERE HV.MAHV = L.TRGLOP AND L.SISO = (SELECT MAX(SISO) FROM LOP)

-- 25. * Tìm họ tên những LOPTRG thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả
-- các lần thi).
SELECT HV.HO, HV.TEN
FROM HOCVIEN HV
JOIN LOP L ON HV.MAHV = L.TRGLOP
WHERE (SELECT COUNT(DISTINCT MAMH)
       FROM KETQUATHI KQ
       WHERE KQ.MAHV = HV.MAHV AND KQ.KQUA = 'Dat'
         AND NOT EXISTS (
             SELECT 1
             FROM KETQUATHI KQ2
             WHERE KQ.MAHV = KQ2.MAHV AND KQ.MAMH = KQ2.MAMH AND KQ2.KQUA = 'Dat')
       ) <= 3;

-- 26. Tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.
SELECT TOP 1 HV.MAHV, HV.HO + ' ' + HV.TEN AS HOTEN, COUNT(*) AS SoMonDiem910
FROM HOCVIEN HV
JOIN KETQUATHI KQ ON KQ.MAHV = HV.MAHV
WHERE DIEM IN (9, 10)
GROUP BY HV.MAHV, HV.HO, HV.TEN
ORDER BY SoMonDiem910 DESC

-- 27. Trong từng lớp, tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.
WITH HocVienDiem910 AS (
    SELECT HOCVIEN.MALOP, HOCVIEN.MAHV, HO + ' ' + TEN AS HOTEN, COUNT(*) AS SoMonDiem910
    FROM KETQUATHI 
    JOIN HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
    WHERE DIEM IN (9, 10)
    GROUP BY HOCVIEN.MALOP, HOCVIEN.MAHV, HO, TEN
)
SELECT MALOP, MAHV, HOTEN, SoMonDiem910
FROM HocVienDiem910 AS hv1
WHERE SoMonDiem910 = (
    SELECT MAX(SoMonDiem910)
    FROM HocVienDiem910 AS hv2
    WHERE hv1.MALOP = hv2.MALOP
)

-- 28. Trong từng học kỳ của từng năm, mỗi giáo viên phân công dạy bao nhiêu môn học, bao
-- nhiêu lớp.
SELECT GD.NAM, GD.HOCKY, GD.MAGV, 
       COUNT(DISTINCT MAMH) AS SoMonHoc, 
       COUNT(DISTINCT MALOP) AS SoLop
FROM GIANGDAY GD 
GROUP BY GD.NAM, GD.HOCKY, GD.MAGV;

-- 29. Trong từng học kỳ của từng năm, tìm giáo viên (mã giáo viên, họ tên) giảng dạy nhiều nhất.
WITH SoTietGiangDay AS (
    SELECT NAM, HOCKY, MAGV, COUNT(*) AS SoTiet
    FROM GIANGDAY
    GROUP BY NAM, HOCKY, MAGV
)
SELECT NAM, HOCKY, GV.MAGV, HOTEN, SoTiet
FROM SoTietGiangDay AS gd
JOIN GIAOVIEN GV ON gd.MAGV = GV.MAGV
WHERE SoTiet = (
    SELECT MAX(SoTiet)
    FROM SoTietGiangDay AS gd2
    WHERE gd.NAM = gd2.NAM AND gd.HOCKY = gd2.HOCKY
)

-- 30. Tìm môn học (mã môn học, tên môn học) có nhiều học viên thi không đạt (ở lần thi thứ 1) nhất.
SELECT TOP 1 MONHOC.MAMH, TENMH, COUNT(*) AS SoHocVienKhongDat
FROM KETQUATHI 
JOIN MONHOC ON KETQUATHI.MAMH = MONHOC.MAMH
WHERE KQUA = 'Khong dat' AND LANTHI = 1
GROUP BY MONHOC.MAMH, TENMH
ORDER BY SoHocVienKhongDat DESC

-- 31. Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi thứ 1).
SELECT MAHV, HO + ' ' + TEN AS HOTEN
FROM HOCVIEN
WHERE NOT EXISTS (
    SELECT 1
    FROM KETQUATHI
    WHERE KETQUATHI.MAHV = HOCVIEN.MAHV
      AND LANTHI = 1
      AND KQUA = 'Khong dat'
)

-- 32. * Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi sau cùng).
SELECT HV.MAHV, HV.HO + ' ' + HV.TEN AS HOTEN
FROM HOCVIEN HV
JOIN KETQUATHI KQ ON HV.MAHV = KQ.MAHV
WHERE KQ.LANTHI = (
    SELECT MAX(KQ2.LANTHI)
    FROM KETQUATHI KQ2
    WHERE KQ2.MAHV = KQ.MAHV AND KQ2.MAMH = KQ.MAMH
)
GROUP BY HV.MAHV, HV.HO, HV.TEN
HAVING MIN(KQ.KQUA) = 'Dat';

-- 33. * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi thứ 1).
SELECT HV.MAHV, HV.HO + ' ' + HV.TEN AS HOTEN
FROM HOCVIEN HV
JOIN KETQUATHI KQ ON HV.MAHV = KQ.MAHV
WHERE KQ.LANTHI = 1
GROUP BY HV.MAHV, HV.HO, HV.TEN
HAVING MIN(KQ.KQUA) = 'Dat';

-- 34. * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi sau cùng).
SELECT HV.MAHV, HV.HO + ' ' + HV.TEN AS HOTEN
FROM HOCVIEN HV
JOIN KETQUATHI KQ ON HV.MAHV = KQ.MAHV
WHERE KQ.LANTHI = (
    SELECT MAX(KQ2.LANTHI)
    FROM KETQUATHI KQ2
    WHERE KQ2.MAHV = KQ.MAHV AND KQ2.MAMH = KQ.MAMH
)
GROUP BY HV.MAHV, HV.HO, HV.TEN
HAVING MIN(KQ.KQUA) = 'Dat';

-- 35. ** Tìm học viên (mã học viên, họ tên) có điểm thi cao nhất trong từng môn (lấy điểm ở lần
-- thi sau cùng).
SELECT HV.MAHV, HV.HO + ' ' + HV.TEN AS HOTEN, KQ.MAMH, KQ.DIEM
FROM HOCVIEN HV
JOIN KETQUATHI KQ ON HV.MAHV = KQ.MAHV
WHERE KQ.LANTHI = (
    SELECT MAX(KQ2.LANTHI)
    FROM KETQUATHI KQ2
    WHERE KQ2.MAHV = KQ.MAHV AND KQ2.MAMH = KQ.MAMH
)
AND KQ.DIEM = (
    SELECT MAX(KQ3.DIEM)
    FROM KETQUATHI KQ3
    WHERE KQ3.MAMH = KQ.MAMH
)
ORDER BY KQ.MAMH, KQ.DIEM DESC;